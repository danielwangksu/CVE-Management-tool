<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- CSS -->
    <!-- bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    <!-- bootstrap CSS -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
    <!-- <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='/css/fontawesome-5.15.1/all.css') }}"> -->
    <!-- resizableColumns CSS -->
    <link href="https://unpkg.com/jquery-resizable-columns@0.2.3/dist/jquery.resizableColumns.css" rel="stylesheet">
    <!-- bootstrap-table CSS -->
    <link rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.18.1/dist/bootstrap-table.min.css">
    <!-- JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.0.4/socket.io.js" integrity="sha512-aMGMvNYu8Ue4G+fHa359jcPb1u+ytAF+P2SCb+PxrjCdO3n3ZTxJ30zuH39rimUggmTwmh2u7wvQsDTHESnmfQ==" crossorigin="anonymous"></script>
    <!-- bootstrap-table JS -->
    <script src="https://unpkg.com/bootstrap-table@1.18.1/dist/bootstrap-table.min.js"></script>
    <!-- tableExport & plugin JS -->
    <script src="https://unpkg.com/tableexport.jquery.plugin/tableExport.min.js"></script>
   <!--  <script src="https://unpkg.com/tableexport.jquery.plugin@1.10.1/tableExport.min.js"></script> -->
    <script src="https://unpkg.com/bootstrap-table@1.18.1/dist/extensions/export/bootstrap-table-export.min.js"></script>
    <!-- <script src="https://unpkg.com/bootstrap-table@1.13.3/dist/extensions/export/bootstrap-table-export.min.js"></script> -->
    <!-- fiterControl & plugin JS -->
    <script src="https://unpkg.com/bootstrap-table@1.18.1/dist/extensions/filter-control/bootstrap-table-filter-control.min.js"></script>
    <!-- <script src="https://unpkg.com/bootstrap-table@1.13.3/dist/extensions/filter-control/bootstrap-table-filter-control.min.js"></script> -->
    <!-- resizableColumns & plugin JS -->
    <script src="https://unpkg.com/jquery-resizable-columns@0.2.3/dist/jquery.resizableColumns.min.js"></script>
    <script src="https://unpkg.com/bootstrap-table@1.18.1/dist/extensions/resizable/bootstrap-table-resizable.min.js"></script>
    <!-- <script src="https://unpkg.com/bootstrap-table@1.13.3/dist/extensions/resizable/bootstrap-table-resizable.min.js"></script> -->
    <!-- toolbar plugin JS -->
    <script src="https://unpkg.com/bootstrap-table@1.18.1/dist/extensions/toolbar/bootstrap-table-toolbar.min.js"></script>
    <!-- <script src="https://unpkg.com/bootstrap-table@1.13.3/dist/extensions/toolbar/bootstrap-table-toolbar.min.js"></script> -->

    <title>CVE Vulnerability Tracking</title>
  </head>

<body>
  <header class="navbar navbar-expand navbar-dark bg-dark">
    <div class="navbar-nav-scroll">
    <ul class="navbar-nav bd-navbar-nav">
      <li class="nav-item">
        <a class="nav-link" href="{{ url_for('launch_page') }}">Unpatched</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="{{ url_for('patched_page') }}">Patched</a>
      </li>
    </ul>
  </div>
  </header>

  <main class="bd-masthead" id="content" role="main">
  <div class="container">

    <div class="modal fade" id="confirm_modal" tabindex="-1" role="dialog" aria-hidden="true">
      <div class="modal-dialog" role="document">
          <div class="modal-content">
              <div id="confirm_alert" class="alert alert-warning center-block" style="width:100%;">
                <div class="modal-header">
                 <a>Are you sure to update those items?</a>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="modal-footer">
                  <button type="button" id="confirm" class="btn btn-secondary">Confirm</button>
                  <button type="button" id="cancel" data-dismiss="modal" class="btn btn-primary">Cancel</button>
                </div>
              </div>
          </div>
      </div>
    </div>

    <div class="modal fade" id="delete_confirm_modal" tabindex="-1" role="dialog" aria-hidden="true">
      <div class="modal-dialog" role="document">
          <div class="modal-content">
              <div id="delete_confirm_alert" class="alert alert-warning center-block" style="width:100%;">
                <div class="modal-header">
                 <a>Are you sure to delete those items?</a>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="modal-footer">
                  <button type="button" id="delete_confirm" class="btn btn-secondary">Confirm</button>
                  <button type="button" id="cancel" data-dismiss="modal" class="btn btn-primary">Cancel</button>
                </div>
              </div>
          </div>
      </div>
    </div>

    <div class="modal" id="fail_alert_modal" tabindex="-1" role="dialog" aria-hidden="true">
      <div class="modal-dialog" role="document">
          <div class="modal-content">
              <div id="fail_alert" class="alert alert-warning center-block" style="width:100%;">
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                  <a id="modal_fail_text"></a>
              </div>
          </div>
      </div>
    </div>

    <div class="modal" id="success_alert_modal" tabindex="-1" role="dialog" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div id="success_alert" class="alert alert-success center-block" style="width:100%;">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
                <a id="modal_success_text"></a>
            </div>
        </div>
      </div>
    </div>

    <div class="row justify-content-md-center">
    <h3>{{ name }}</h3>
    </div>

    <div class="row justify-content-md-center">
      <div id="toolbar">
        <button id="show-all" class="btn btn-secondary">Show All</button>
        <button id="reset" class="btn btn-secondary">Reset Search</button>
        <button id="update" class="btn btn-secondary">{{ change_status }}</button>
        <button id="delete" class="btn btn-secondary">Delete</button>
      </div>
    <table
      id="table"
      data-height="850"
      data-toolbar="#toolbar"
      class="table-sm table-hover"
      data-sort-name="cve"
      data-sort-order="desc"
      data-cache="false"
      data-show-refresh="true"
      data-show-toggle="true"
      data-show-columns="true"
      data-show-export="true"
      data-show-pagination-switch="true"
      data-sort-class="table-active"
      data-row-attributes="rowAttributes"
      data-click-to-select="false"
      data-pagination-pre-text="Previous"
      data-pagination-next-text="Next"
      data-advanced-search="true"
      data-id-table="advancedTable"
      data-filter-show-clear="true"
      data-page-list="[10, 25, 50, 100, ALL]">
      <thead>
        <tr>
          <th data-field="state" data-checkbox="true"></th>
          <th data-field="cvssv2" data-align="center" data-valign="middle" data-sortable="true">CVSSv2</th>
          <th data-field="package" data-align="center" data-valign="middle" data-sortable="true">Package</th>
          <th data-field="version" data-align="center" data-valign="middle" data-width="50" data-sortable="true">Version</th>
          <th data-field="cve" data-align="center" data-valign="middle" data-width="400" data-sortable="true">CVE</th>
          <th data-field="vector" data-align="center" data-valign="middle" data-width="50" data-sortable="true">Vector</th>
          <th data-field="summary" data-halign="center" data-align="left" class="summary-special">Summary</th>
          <th data-field="detail" data-align="center" data-valign="middle" data-formatter="urlFormatter">Detail</th>
          <th data-field="status" data-align="center" data-valign="middle">Status</th>
        </tr>
      </thead>
    </table>
    </div>
  </div>

<!-- data-filter-control="true" -->
<!-- JS -->
<script type="text/javascript" charset="utf-8">
  var $table = $('#table')
  var $showall = $('#show-all')
  var $reset = $('#reset')
  var $update = $('#update')
  var $confirm = $('#confirm')
  var $delete = $('#delete')
  var $delete_confirm = $('#delete_confirm')

  function rowAttributes(row, index) {
    return {
      'data-toggle': 'popover',
      'data-placement': 'bottom',
      'data-trigger': 'hover',
      'data-content': [
        'CVE: ' + row['cve'],
        'Name: ' + row['package'],
        'Version: ' + row['version'],
      ].join(', ')
    }
  }

  function urlFormatter(value) {
    return '<a href="' + value +'">link</a>'
  }

  function summaryStyle(value, row, index, field) {
  }

  function SummaryFormatter(value) {
  }

  function populate_table() {
    var json = {{ record|tojson }}
    var data = []
    for (var i = 0; i < json.length; i++) {
      var item = {
        'id':json[i].id,
        'cvssv2':json[i].cvssv2,
        'package':json[i].package,
        'version':json[i].version,
        'cve':json[i].cve,
        'vector':json[i].vector,
        'summary':json[i].summary,
        'detail':json[i].detail,
        'status':json[i].status
      }
      data.push(item)
    }
    $table.bootstrapTable({
      data: data,
      pageSize: 8,
      pagination: true,
      search: true,
      undefinedText: 'N/A',
      theadClasses: 'thead-light',
    })
  }

  $(function() {
    populate_table()

    var pathname = window.location.pathname

    $('.nav-link').each(function(i) {
      // console.log($(this).text())
      // console.log(pathname)
      if (pathname === "/" + $(this).text().toLowerCase()) {
        $(this).addClass('active') 
      }
    })

    $table.on('post-body.bs.table', function (e) {
      $('[data-toggle="popover"]').popover()
    })

    // $table.bootstrapTable('hideColumn', 'status')

    $showall.click(function () {
      $table.bootstrapTable('togglePagination')
    })

    $reset.click(function () {
      $table.bootstrapTable('resetSearch')
    })

    $update.click(function () {
      $("#confirm_modal").modal('show')
    })

    $confirm.click(function () {
      $("#confirm_modal").modal('hide')
      var row = $table.bootstrapTable('getSelections')
      var ids = $.map($table.bootstrapTable('getSelections'), function (row) {
        return row.id
      })

      var socket = io("/update")

      socket.on('connect', function() {
        if (row.length < 1) {
          console.log('no row is selected, return')
          return
        }
        socket.emit('update_record', row, '{{change_status}}' )

        socket.on('disconnect', function () {
          console.log('Disconnected');
        })
      })

      socket.on('update_record_response', function(msg) {
        if (msg.result == "success"){
          console.log(msg)
          $table.bootstrapTable('remove', {
            field: 'id',
            values: ids
          })
          $("#fail_alert_modal").modal('hide')
          $("#success_alert_modal").modal('show')
          $("#modal_success_text").html('The update submitted <strong>Successfully!</strong>')
        } else {
          $("#fail_alert_modal").modal('show')
          $("#success_alert_modal").modal('hide')
          $("#modal_fail_text").html('The update failed <strong>with errors</strong>')
        }

        socket.on('disconnect', function () {
          console.log('Disconnected');
        })
      })
    })

    $delete.click(function () {
      $("#delete_confirm_modal").modal('show')
    })

    $delete_confirm.click(function () {
      $("#delete_confirm_modal").modal('hide')
      var row = $table.bootstrapTable('getSelections')
      var ids = $.map($table.bootstrapTable('getSelections'), function (row) {
        return row.id
      })

      var socket = io("/delete")

      socket.on('connect', function() {
        if (row.length < 1) {
          console.log('no row is selected, return')
          return
        }
        socket.emit('delete_record', row)

        socket.on('disconnect', function () {
          console.log('Disconnected');
        })
      })

      socket.on('delete_record_response', function(msg) {
        if (msg.result == "success"){
          console.log(msg)
          $table.bootstrapTable('remove', {
            field: 'id',
            values: ids
          })
          $("#fail_alert_modal").modal('hide')
          $("#success_alert_modal").modal('show')
          $("#modal_success_text").html('The item has been deleted <strong>Successfully!</strong>')
        } else {
          $("#fail_alert_modal").modal('show')
          $("#success_alert_modal").modal('hide')
          $("#modal_fail_text").html('The item failed to be deleted <strong>with errors</strong>')
        }

        socket.on('disconnect', function () {
          console.log('Disconnected');
        })
      })
    })

  })
</script>

</main>
</body>
</html>